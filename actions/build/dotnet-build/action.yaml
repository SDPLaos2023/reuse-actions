name: "Build and Test .NET Application"
description: "Builds a .NET application to be tested and deployed to IIS."

inputs:
  source_code_path:
    description: "Path to the .NET project"
    required: false
    default: "./"
  configuration:
    description: "Build configuration"
    required: false
    default: "Release"
  publish_output_path:
    description: "Output directory for published application"
    required: false
    default: "publish"

runs:
  using: "composite"
  steps:
    - name: Find .csproj file
      shell: powershell
      run: |
        Set-Location -Path ${{ inputs.source_code_path }}
        $csprojFile = Get-ChildItem -Filter "*.csproj" | Select-Object -First 1
        if ($null -eq $csprojFile) {
          Write-Error "No .csproj file found in ${{ inputs.source_code_path }}"
          exit 1
        }
        Write-Host "Found .csproj file: $($csprojFile.FullName)"
        echo "CSPROJ_PATH=$($csprojFile.FullName)" >> $env:GITHUB_ENV

    - name: Restore dependencies
      shell: powershell
      run: |
        dotnet restore "$env:CSPROJ_PATH"

    - name: Build project
      shell: powershell
      run: |
        dotnet build "$env:CSPROJ_PATH" --configuration ${{ inputs.configuration }} --no-restore

    - name: Run tests
      shell: powershell
      run: |
        dotnet test "$env:CSPROJ_PATH" --configuration ${{ inputs.configuration }} --no-build --verbosity normal

    - name: Publish app
      shell: powershell
      run: |
        dotnet publish "$env:CSPROJ_PATH" -c ${{ inputs.configuration }} -o ${{ inputs.source_code_path }}/${{ inputs.publish_output_path }}
        ls
